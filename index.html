<!DOCTYPE html>

<html>
    <head>
        <title>sikchat</title>
        <link rel="stylesheet" type="text/css" href="css/normalize.css">
        <link rel="stylesheet" type="text/css" href="css/sikchat.css">
    </head>
    <body>
        <div class="user-name-display">someone</div>
        <div class="header">
            <form id="form">
                <input id="message-input" name="message-input" autofocus="true" autocomplete="off" maxlength="280" /><button id="submit-button">></button>
            </form>

            <div class="spacer"></div>

            <div class="logo-column">
                <div class="ghost-drawer"><div class="ghost-logo">sikchat</div></div>
                <div class="drawer">
                    <div class="drawer-contents">
                        <div class="drawer-item">
                            <div>
                                <label>moniker</label> 
                            </div>
                            <div>
                                <input id="username" name="username" autocomplete="off" spellcheck="false" maxlength="20" />
                            </div>
                        </div>
                    </div>

                    <div class="drawer-handle">
                        <span id="logo">sikchat</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-body">
                <div id="messages"></div>
                <div class="spacer"></div>
                <div class="extra"></div>
        </div>

        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.5.0.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js" integrity="sha512-v8ng/uGxkge3d1IJuEo6dJP8JViyvms0cly9pnbfRxT6/31c3dRWxIiwGnMSWwZjHKOuY3EVmijs7k1jz/9bLA==" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-latest.min.js" integrity="sha512-vs7+jbztHoMto5Yd/yinM4/y2DOkPLt0fATcN+j+G4ANY2z4faIzZIOMkpBmWdcxt+596FemCh9M18NUJTZwvw==" crossorigin="anonymous"></script>
        
        <script>
            
            /* ------------------ SETUP -------------------- */

            var userInputElement = document.getElementById('username')
            var messageInputElement = document.getElementById('message-input')
            var submitButtonElement = document.getElementById('submit-button')

            var socket = io()
            
            /* -------------------- UI --------------------- */

            // --- username & drawer logic
            userInputElement.addEventListener("keydown", e => {
                if(e.code == "Enter" || e.code == "NumpadEnter" || e.code == "Tab")
                e.preventDefault()

                if(e.code == "Enter" || e.code == "NumpadEnter") {
                    closeDrawerFocusMessageInput()
                }
                else if (e.shiftKey && e.code == "Tab") {
                    submitButtonElement.focus() 
                }
                else if (e.code == "Tab") {
                    messageInputElement.focus()
                }
            })
            
            var userInputMouseDown = false
            var userInputArrivedByTab = false
            var drawerIsFreeFloating = false

            document.body.addEventListener('mousedown', function (e) {
                if(e.targetid != "username") {
                    userInputArrivedByTab = false
                }
            })

            userInputElement.addEventListener('mousedown', function () {
                userInputMouseDown = true
            })
            
            userInputElement.addEventListener('focusin', function () {
                if(!userInputMouseDown && !drawerIsOpen()) {
                    openDrawer()
                    userInputArrivedByTab = true
                }
                userInputMouseDown = false
            })
            
            userInputElement.addEventListener("blur", e => {
                if(userInputArrivedByTab)
                closeDrawer()
                
                userInputArrivedByTab = false
                document.querySelector(".user-name-display").innerHTML = e.target.value
            })
            
            document.querySelector('.drawer-handle').addEventListener("click", toggleDrawerFreeFLoat)
            
            
            // --- send chat
            document.getElementById('form').addEventListener('submit', e => {
                e.preventDefault()
                
                let text = messageInputElement.value
                if(!text) return false
                let username = userInputElement.value || 'someone'
                
                socket.emit('chat_message', { text, username })
            })

            // --- receive chat
            socket.on('chat_message', msg => { 
                let user = userInputElement.value || 'someone'; 
                let messageClass = user == msg.username && user != 'someone'
                    ? 'message-output is-current-user'
                    : 'message-output'

                // add new message to UI
                const markup = `<div class='${messageClass}'><div class='user-name'><span>${msg.username}</span></div><p class='output-text'>${msg.text}</p></div>`
                $(markup).appendTo("#messages")
                messageInputElement.value = ""
            })



            /* ------------------ FUNCTIONS ------------------ */

            function openDrawer() {
                document.body.classList.add("drawer-is-open");
            }

            function closeDrawer() {
                document.body.classList.remove("drawer-is-open");
            }

            function toggleDrawerFreeFLoat() {
                drawerIsOpen() ? closeDrawer() : openDrawer()
            }

            function closeDrawerFocusMessageInput() {
                closeDrawer();
                messageInputElement.focus()
            }

            function drawerIsOpen() {
                return document.body.classList.contains("drawer-is-open")
                    ? true
                    : false
            }

        </script>
    </body>
</html>